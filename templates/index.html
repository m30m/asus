{% extends 'base.html' %}
{% block title %} Admin Dashboard {% endblock %}
{% block header %}
<script src="https://unpkg.com/vue-query-builder@0.7.1/dist/VueQueryBuilder.umd.min.js"></script>
<link
  rel="stylesheet"
  href="https://unpkg.com/vue-query-builder@0.8.2/dist/VueQueryBuilder.css"
/>
{% endblock %}
{% block body %}{% raw %}
    <div id="app">
        <h1 class="ui center aligned header">Admin Control Panel</h1>
        <h2 class="ui center aligned header">Create a Device</h2>
        <div class="ui container">
            <div class="ui segments">
                <div class="ui segment"><a href="/lamp" target="_blank">Create a lamp</a></div>
                <div class="ui segment"><a href="/door" target="_blank">Create a door</a></div>
                <div class="ui segment"><a href="/motion" target="_blank">Create a motion sensor</a></div>
                <div class="ui segment"><a href="/noise" target="_blank">Create a noise sensor</a></div>
                <div class="ui segment"><a href="/proximity" target="_blank">Create a proximity sensor</a></div>
            </div>
        </div>

        <h2 class="ui center aligned header">State of Devices</h2>
        <div class="ui container">
            <table class="ui celled table">
                <thead>
                <th>Device ID</th>
                <th>Type</th>
                <th>State</th>
                </thead>
                <tbody>
                <tr v-for="item in devices">
                    <td>
                        {{item.id}}
                    </td>
                    <td>
                        {{item.type}}
                    </td>
                    <td>
                        {{item.state}}
                    </td>

                </tr>

                </tbody>
            </table>
        </div>

        Current rules:
        <ul>
            <li v-for="rule in rules">
                {{ rule.name }} : <input type="button" @click="edit_rule(rule)" value="Edit"/>
                <input type="button" @click="delete_rule(rule)" value="Delete"/>
            </li>
            <li><input type="button" @click="add_rule" value="Add new rule"/></li>
        </ul>
        <div :class="{hidden:!builder_state}" v-if="builder_state">
            <input type="text" placeholder="Rule Name" v-model="current_rule_name"/>
            <vue-query-builder :rules="builder_rules" v-model="current_query"></vue-query-builder>
            <br/>
            Actions:
            <br/>
            <div v-for="action in current_actions">
                Device:
                <select v-model="action.device_id">
                    <option v-for="actuator in actuators" v-bind:value="actuator.id">{{ actuator.id }}</option>
                </select>

                <select v-if="action.device_id" v-model="action.value">
                    <option v-for="act in get_actions(action.device_id)" v-bind:value="act.value">{{ act.label }}
                    </option>
                </select>
                <input type="button" @click="current_actions.splice(current_actions.indexOf(action),1)" value="Delete"/>
            </div>
            <input @click="current_actions.push({device_id:null,value:null})" type="button" value="Add action"/>
            <input type="button" @click="save_rule" value="Save rule"/>
        </div>
    </div>
    <script type="text/javascript" charset="utf-8">
    var app = new Vue({
      el: '#app',
      data: {
        devices: [],
        socket: null,
        builder_rules: [],
        rules: [],
        builder_state: false,
        current_rule_name: '',
        current_query: {},
        current_rule: null,
        current_actions: []
      },
      components: {VueQueryBuilder: window.VueQueryBuilder},
      computed: {
        actuators: function () {
          return this.devices.filter(function (device) {
            return device.is_actuator
          })
        }
      },
      methods: {
        send_state: function (device_id, state) {
          socket.emit('act', {device_id: device_id, state: state})
        },
        add_rule: function () {
          this.current_query = {}
          this.current_rule_name = ''
          this.current_rule = null
          this.current_actions = []
          this.builder_state = true
        },
        edit_rule: function (rule) {
          this.current_rule = rule
          this.builder_state = true
          this.current_query = rule.query
          this.current_rule_name = rule.name
          this.current_actions = rule.actions
        },
        save_rule: function () {
          console.log(this.current_query)
          if (this.current_rule == null) {
            this.rules.push({
              'name': this.current_rule_name,
              'query': this.current_query,
              'actions': this.current_actions
            })
          } else {
            this.current_rule.query = this.current_query
            this.current_rule.name = this.current_rule_name
            this.current_rule.actions = this.current_actions
          }
          this.builder_state = false
          socket.emit('update_rules', this.rules)
        },
        delete_rule: function (rule) {
          this.rules.splice(this.rules.indexOf(rule), 1)
          socket.emit('update_rules', this.rules)
        },
        get_type: function (device_id) {
          for (var device of this.devices)
            if (device.id === device_id)
              return device.type
        },
        get_actions: function (device_id) {
          let type = this.get_type(device_id)
          if (type === 'door') {
            return [{ 'value': false, 'label': 'Lock Door' }, { 'value': true, 'label': 'Unlock Door' }]
          }
          if (type === 'lamp') {
            return [{ 'value': false, 'label': 'Turn Off' }, { 'value': true, 'label': 'Turn On' }]
          }
        }
      },
      created: function () {
        console.log('Starting connection to WebSocket Server')
        socket = io()
        this.socket = socket
        let vm = this
        socket.on('connect', function () {
          socket.emit('admin', {})
        })
        socket.on('update', data => {
          console.log(data)
          vm.devices = data.devices
          vm.builder_rules = data.builder_rules
          vm.rules = data.rules
        })
      }
    })
  </script>
  {% endraw %}
  {% endblock %}